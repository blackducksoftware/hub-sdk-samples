package com.blackducksoftware.integration.HubSdkSamples;

import java.net.MalformedURLException;
import java.net.URL;
import java.util.List;

import com.blackducksoftware.integration.exception.IntegrationException;
import com.blackducksoftware.integration.hub.api.component.ComponentRequestService;
import com.blackducksoftware.integration.hub.api.item.MetaService;
import com.blackducksoftware.integration.hub.api.vulnerability.VulnerabilityRequestService;
import com.blackducksoftware.integration.hub.model.response.ComponentSearchResultResponse;
import com.blackducksoftware.integration.hub.model.view.ComponentView;
import com.blackducksoftware.integration.hub.model.view.VulnerabilityView;
import com.blackducksoftware.integration.hub.rest.CredentialsRestConnection;
import com.blackducksoftware.integration.hub.service.HubServicesFactory;
import com.blackducksoftware.integration.log.IntLogger;
import com.blackducksoftware.integration.test.TestLogger;


/**
 * Sample program to show how to get vulnerability Info for a component/version
 *
 */
public class SampleGetComponentVulnerability {
	
	private static String serverAddress;
    private static String username;
    private static String password;
    private static String namespace;
    private static String groupId;
    private static String artifactId;
    private static String version;
    private static HubServicesFactory hubServicesFactory;
    private static final IntLogger logger = new TestLogger();
    private static final int timeOut = 10000;
       
	/**
	 * Connects to server. Username, password, and server address taken from command line
	 * @return credentialsRestConnection
	 * @throws MalformedURLException
	 * @throws IntegrationException
	 */
	public static CredentialsRestConnection connect() throws MalformedURLException, IntegrationException {
		URL serverAddressURL = new URL(serverAddress);
		CredentialsRestConnection credentialsRestConnection = new CredentialsRestConnection(logger, serverAddressURL, username, password, timeOut);
		credentialsRestConnection.connect();
		credentialsRestConnection.logger = logger;
		return credentialsRestConnection;
	}
	
	/**
	 * Parses command line arguments.
	 * @param args
	 */
	public static void parseCommandLineArguments(String args[]){		
		try{
			serverAddress = args[0];
			username = args[1];
			password = args[2];
			namespace = args[3];
			groupId = args[4];
			artifactId = args[5];
			version = args[6];
		} 
		catch (Exception e){
			System.out.println("Usage: java SampleGetComponentVulnerability.java serverAddress username password namespace groupId artifactId version");
			System.exit(1);
		}
	}
	
	

	public static void main(String[] args) throws IntegrationException, MalformedURLException {
		
		// connect and create hubServicesFactory
		parseCommandLineArguments(args);
		CredentialsRestConnection credentialsRestConnection = connect();
		hubServicesFactory = new HubServicesFactory(credentialsRestConnection);
		
		// create needed required Request Services
		ComponentRequestService componentRequestService = hubServicesFactory.createComponentRequestService();
		VulnerabilityRequestService vulnerabilityRequestService = hubServicesFactory.createVulnerabilityRequestService();
        final MetaService metaService = hubServicesFactory.createMetaService(logger);
        
        // Search for component and store into ComponentView object
		ComponentSearchResultResponse componentSearchResult = 
				componentRequestService.getExactComponentMatch(namespace, groupId, artifactId, version);	
		ComponentView component = componentRequestService.getItem(componentSearchResult.component, ComponentView.class);
		
		// retrieve vulnerabilities url from component using metaservice
		String vulnerabilitiesUrl = metaService.getFirstLink(component, MetaService.VULNERABILITIES_LINK);	
		List<VulnerabilityView> vulnerabilityViews = vulnerabilityRequestService.getComponentVersionVulnerabilities(vulnerabilitiesUrl);	
		
		// you now have a list of vulnerability information for a component
		System.out.println(vulnerabilityViews);
	}
}
