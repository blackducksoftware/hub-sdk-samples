package com.blackducksoftware.integration.HubSdkSamples;

import java.net.MalformedURLException;
import java.util.List;

import com.blackducksoftware.integration.exception.IntegrationException;
import com.blackducksoftware.integration.hub.api.component.ComponentRequestService;
import com.blackducksoftware.integration.hub.api.item.MetaService;
import com.blackducksoftware.integration.hub.api.vulnerability.VulnerabilityRequestService;
import com.blackducksoftware.integration.hub.model.response.ComponentSearchResultResponse;
import com.blackducksoftware.integration.hub.model.view.ComponentView;
import com.blackducksoftware.integration.hub.model.view.VulnerabilityView;


/**
 * Sample program to show how to get vulnerability Info for a component/version
 *
 */
public class SampleGetComponentVulnerability extends AbstractSample{
	
    private static String namespace;
    private static String groupId;
    private static String artifactId;
    private static String version;
       
    
	@Override
	public void parseCommandLineArguments(String[] args) {		
		try{
			serverAddress = args[0];
			username = args[1];
			password = args[2];
			namespace = args[3];
			groupId = args[4];
			artifactId = args[5];
			version = args[6];
		} 
		catch (Exception e){
			System.out.println("Usage: java SampleGetComponentVulnerability.java serverAddress username password namespace groupId artifactId version");
			System.exit(1);
		}
	}

	
	@Override
	public void execute() throws MalformedURLException, IntegrationException{
		
		// create needed required Request Services
		ComponentRequestService componentRequestService = hubServicesFactory.createComponentRequestService();
		VulnerabilityRequestService vulnerabilityRequestService = hubServicesFactory.createVulnerabilityRequestService();
        final MetaService metaService = hubServicesFactory.createMetaService(logger);
        
        // Search for component and store into ComponentView object
		ComponentSearchResultResponse componentSearchResult = 
				componentRequestService.getExactComponentMatch(namespace, groupId, artifactId, version);	
		ComponentView component = componentRequestService.getItem(componentSearchResult.component, ComponentView.class);
		
		// retrieve vulnerabilities URL from component using metaservice
		String vulnerabilitiesUrl = metaService.getFirstLink(component, MetaService.VULNERABILITIES_LINK);	
		List<VulnerabilityView> vulnerabilityViews = vulnerabilityRequestService.getComponentVersionVulnerabilities(vulnerabilitiesUrl);	
		
		// you now have a list of vulnerability information for a component
		System.out.println(vulnerabilityViews);		
	}
	

	public static void main(String[] args) throws IntegrationException, MalformedURLException {
		SampleGetComponentVulnerability sampleGetComponentVulnerability = new SampleGetComponentVulnerability();
		sampleGetComponentVulnerability.parseCommandLineArguments(args);
		sampleGetComponentVulnerability.connect();
		sampleGetComponentVulnerability.execute();
	}
}
